---

- name: Find apt source files
  ansible.builtin.find:
    paths:
      - /etc/apt
      - /etc/apt/sources.list.d
    patterns:
      - sources.list
      - '*.list'
      - '*.sources'
    file_type: file
  register: ubuntu_apt_source_files
  changed_when: false

- name: Switch archive mirrors to old-releases
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: 'https?://[^\s]*archive\.ubuntu\.com/ubuntu/?'
    replace: '{{ ubuntu_old_releases_mirror }}/'
  loop: "{{ ubuntu_apt_source_files.files | default([]) }}"
  loop_control:
    label: "{{ item.path }}"

- name: Switch security mirror to old-releases
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: 'https?://security\.ubuntu\.com/ubuntu/?'
    replace: '{{ ubuntu_old_releases_mirror }}/'
  loop: "{{ ubuntu_apt_source_files.files | default([]) }}"
  loop_control:
    label: "{{ item.path }}"
