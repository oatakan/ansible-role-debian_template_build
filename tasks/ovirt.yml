---

- name: ensure apt cache is updated (pre ovirt guest agent)
  block:
    - name: Update apt cache (pre ovirt guest agent)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0
        force_apt_get: true
        update_cache_retries: 10
        update_cache_retry_max_delay: 12
  rescue:
    - name: Detect EOL-style Ubuntu apt mirror failure (pre ovirt guest agent)
      ansible.builtin.set_fact:
        ubuntu_apt_eol_mirror_error: >-
          {{
            (ansible_failed_result.msg | default(''))
            is search(ubuntu_apt_eol_mirror_error_pattern, ignorecase=True)
          }}
      vars:
        ubuntu_apt_eol_mirror_error_pattern: >-
          no longer has a Release file|
          does not have a Release file|
          none found at .*InRelease

    - name: Switch Ubuntu mirrors to old-releases (EOL fallback, pre ovirt guest agent)
      ansible.builtin.include_tasks: ubuntu_old_releases.yml
      when:
        - (ubuntu_switch_to_old_releases_on_failure | default(true)) | bool
        - ansible_distribution == 'Ubuntu'
        - ubuntu_apt_eol_mirror_error | bool

    - name: Retry apt cache update after switching mirrors (pre ovirt guest agent)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0
        force_apt_get: true
        update_cache_retries: 10
        update_cache_retry_max_delay: 12
      when:
        - (ubuntu_switch_to_old_releases_on_failure | default(true)) | bool
        - ansible_distribution == 'Ubuntu'
        - ubuntu_apt_eol_mirror_error | bool
  when: ansible_pkg_mgr == 'apt'

- name: ensure ovirt guest agent package is installed (apt)
  ansible.builtin.apt:
    name: "{{ ovirt_guest_agent_package_name }}"
    state: present
    update_cache: true
    cache_valid_time: 0
    force_apt_get: true
  register: ovirt_guest_agent_install
  retries: 3
  delay: 10
  until: ovirt_guest_agent_install is succeeded
  when: ansible_pkg_mgr == 'apt'

- name: ensure ovirt guest agent package is installed (non-apt)
  ansible.builtin.package:
    name: "{{ ovirt_guest_agent_package_name }}"
    state: present
  when: ansible_pkg_mgr != 'apt'

- name: ensure ovirt guest agent is enabled
  ansible.builtin.service:
    name: "{{ ovirt_guest_agent_service_name }}"
    enabled: true
