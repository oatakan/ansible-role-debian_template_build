---

- name: install required packages
  ansible.builtin.apt:
    name:
      - dkms
      - libelf-dev
      - linux-headers-{{ ansible_kernel | default(kernel_release.stdout) }}
      - build-essential
    state: present

- name: check to see if we have the iso file
  ansible.builtin.stat:
    path: "{{ parallels_tools_iso_file }}"
  register: check_parallels_tools_iso

- block:
    - name: mount parallels iso
      ansible.posix.mount:
        src: "{{ parallels_tools_iso_file }}"
        path: /mnt
        fstype: iso9660
        opts: loop
        state: mounted

    - name: install Parallels Tools
      ansible.builtin.shell: /mnt/install --install-unattended-with-deps
      args:
        chdir: /mnt
      register: install_parallels_tools
  always:
    - name: unmount parallels iso
      ansible.posix.mount:
        path: /mnt
        state: absent

    - name: remove iso file
      ansible.builtin.file:
        path: "{{ parallels_tools_iso_file }}"
        state: absent
  when: check_parallels_tools_iso.stat.exists