FROM {{ item.image }}

ENV container=docker
ENV LANG=C.UTF-8

{% if 'ubuntu' in item.image %}
RUN apt-get update -y && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      systemd systemd-sysv \
      python3 python3-apt \
      openssh-server openssh-client \
      sudo ca-certificates curl \
    netplan.io \
      iproute2 iputils-ping \
      rsync \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
{% else %}
RUN apt-get update -y && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      systemd systemd-sysv \
      python3 python3-apt \
      openssh-server openssh-client \
      sudo ca-certificates curl \
      iproute2 iputils-ping \
      rsync \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
{% endif %}

RUN find /etc/systemd/system /lib/systemd/system \
    -path '*.wants/*' \
    \( -name '*getty*' -o -name '*systemd-tmpfiles*' -o -name '*systemd-update-utmp*' \) \
    -exec rm -f {} + 2>/dev/null || true

RUN ssh-keygen -A -q && \
    echo 'root:root' | chpasswd && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && \
    echo 'UseDNS no' >> /etc/ssh/sshd_config && \
    mkdir -p /var/run/sshd

RUN mkdir -p /etc/systemd/system/multi-user.target.wants && \
    ln -sf /lib/systemd/system/ssh.service /etc/systemd/system/multi-user.target.wants/ssh.service 2>/dev/null || true

RUN mkdir -p /tmp /var/tmp /run /run/lock && \
    chmod 1777 /tmp /var/tmp /run/lock && \
    chmod 755 /run

RUN python3 --version

VOLUME ["/sys/fs/cgroup"]
EXPOSE 22
CMD ["/sbin/init"]
